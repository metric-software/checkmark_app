# CMake Windows third-party licenses configuration module

include_guard(GLOBAL)

file(STRINGS "${VCPKG_INSTALLED_DIR}/vcpkg/status" LINES)
set(ALL_LICENSES_FILE "${CMAKE_BINARY_DIR}/third-party")
file(WRITE "${ALL_LICENSES_FILE}" "")
set(packages "")
foreach(LINE ${LINES})
  if(LINE MATCHES "^Package: (.+)$")
    set(PACKAGE_NAME "${CMAKE_MATCH_1}")
    list(FIND packages "${PACKAGE_NAME}" INDEX)
    if(INDEX EQUAL -1)
        list(APPEND packages "${PACKAGE_NAME}")
        set(COPYRIGHT_PATH "${VCPKG_INSTALLED_DIR}/${VCPKG_TARGET_TRIPLET}/share/${PACKAGE_NAME}/copyright")
        if(EXISTS "${COPYRIGHT_PATH}")
            file(READ "${COPYRIGHT_PATH}" LICENSE_CONTENT)
            file(APPEND "${ALL_LICENSES_FILE}" "@${PACKAGE_NAME}\n\n")
            file(APPEND "${ALL_LICENSES_FILE}" "${LICENSE_CONTENT}\n")
            file(APPEND "${ALL_LICENSES_FILE}" "---------------------------------\n\n")
        endif()
    endif()
  endif()
endforeach()
